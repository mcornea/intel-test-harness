---
- name: Label baremetal worker nodes as worker-cnf
  k8s:
    kind: Node
    name: "{{ hostvars[item].hostname }}"
    resource_definition:
      metadata:
        labels:
          feature.node.kubernetes.io/network-sriov.capable: "true"
  with_items: "{{ groups['baremetal_workers'] }}"

- set_fact:
    package_name: "sriov-network-operator"
  
- import_tasks: "{{ role_path }}/../lib/tasks/get-channel.yml"

- name: Create sriov subscription using template
  k8s:
    state: present
    definition: "{{ lookup('template', 'sub-sriov.yml') }}"

- set_fact:
    namespace: openshift-sriov-network-operator

- import_tasks: "{{ role_path }}/../lib/tasks/wait-csv.yml"

- name: Execute SRIOV interface PCI command on baremetal worker over SSH
  shell: "{{ role_path }}/tasks/exec_over_ssh.sh {{ hostvars[item].hostname }} 'ethtool -i {{ du_sriov_int }} ' | awk '/bus-info:/{print $NF;}'"
  register: pci_info 
  with_items: "{{ groups['baremetal_workers'] }}"

- debug:
    msg: "{{ pci_info.results[0].stdout }}"
  when: debug is defined and debug|int == 1

- set_fact:
    du_sriov_int_pci: "{{ pci_info.results[0].stdout }}"

- name: Apply the SRIOV NIC Policy template
  k8s:
    state: present
    definition: "{{ lookup('template', 'sriov-nic-policy.yml') }}"

- name: Apply the SRIOV Network template
  k8s:
    state: present
    definition: "{{ lookup('template', 'sriov-network.yml') }}"
  register: result

- name: wait for SRIOV VF created
  pause:
    seconds: 30
  when: result.changed 
 
- shell: |
    "{{ role_path }}"/tasks/exec_over_ssh.sh {{ hostvars[item].hostname }} "ip link show {{ du_sriov_int }} | egrep '^\s+vf\s'"
  register: vf_status
  with_items: "{{ groups['baremetal_workers'] }}"

- debug:
    msg: "VF: {{ vf_status.results[0].stdout_lines | length }}"
  when: debug is defined and debug|int == 1

- name: Check VF is created 
  shell: |
    "{{ role_path }}"/tasks/exec_over_ssh.sh {{ hostvars[item].hostname }} "ip link show {{ du_sriov_int }} | egrep '^\s+vf\s'"
  register: vf_status
  retries: 1
  delay: 5
  with_items: "{{ groups['baremetal_workers'] }}"
  until:
    - (vf_status.stdout | length > 0)

